---
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import BlogCard from "../../components/BlogCard.astro";
import "../../styles/global.css";
import { normalizeTags } from "../../utils/normalize"; // ‚úÖ funci√≥n reutilizable
import type { GetStaticPaths, MarkdownInstance } from "astro";

// üß© Tipo del frontmatter
type BlogPostFrontmatter = {
  title: string;
  description: string;
  pubDate: string;
  author: string;
  tags: string[];
  image: {
    url: string;
    alt: string;
  };
};

// ‚úÖ Paso 1: Generar rutas din√°micas para cada etiqueta
export const getStaticPaths: GetStaticPaths = async () => {
  const postImportResult = await Astro.glob<BlogPostFrontmatter>("../posts/*.md");

  const allTags = postImportResult.flatMap(
    (post: MarkdownInstance<BlogPostFrontmatter>) => post.frontmatter.tags ?? []
  );

  const uniqueTags = normalizeTags(allTags);

  return uniqueTags.map((tag) => ({
    params: { tag },
  }));
};

// ‚úÖ Paso 2: Obtener el tag desde la URL
const { tag } = Astro.params;

if (!tag) {
  throw new Error("Etiqueta no especificada.");
}

// ‚úÖ Paso 3: Cargar todos los posts
const postImportResult = await Astro.glob<BlogPostFrontmatter>("../posts/*.md");

const posts = postImportResult.map((p) => ({
  ...p.frontmatter,
  url: p.url!,
}));

// ‚úÖ Paso 4: Filtrar posts por la etiqueta seleccionada
const filteredPosts = posts.filter((post) =>
  normalizeTags(post.tags).includes(String(tag).toLowerCase())
);
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Posts con la etiqueta #{tag}</title>
  </head>
  <body>
    <Header />
    <main style="max-width: 700px; margin: auto; padding: 2rem;">
      <h1>üè∑Ô∏è Posts con la etiqueta: <code>#{tag}</code></h1>

      {filteredPosts.length > 0 ? (
        filteredPosts.map((post) => (
          <BlogCard
            title={post.title}
            description={post.description}
            pubDate={post.pubDate}
            author={post.author}
            tags={post.tags}
            image={post.image}
            url={post.url}
          />
        ))
      ) : (
        <p>No hay publicaciones con esta etiqueta a√∫n.</p>
      )}
    </main>
    <Footer />
  </body>
</html>
